{% extends "base.html" %}

{% block title %}管理员仪表盘{% endblock %}

{# 隐藏基础模板的导航栏 #}
{% set hide_nav = true %}

{% block styles %}
<link href="{{ url_for('static', filename='css/admin.css') }}" rel="stylesheet">
<style>
    body {
        padding-top: 0 !important;
        background-color: var(--bg-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-wrapper">
    <!-- 侧边栏 -->
    <aside class="admin-sidebar">
        <div class="admin-sidebar-header">
            <h1 class="admin-sidebar-title">智汇导航</h1>
        </div>
        <div class="admin-sidebar-content">
            <nav>
                <ul class="admin-nav">
                    <li class="admin-nav-item">
                        <a href="{{ url_for('admin.dashboard') }}" class="admin-nav-link active">
                            <i class="fas fa-tachometer-alt"></i>仪表盘
                        </a>
                    </li>
                    <li class="admin-nav-item">
                        <a href="{{ url_for('admin.settings') }}" class="admin-nav-link">
                            <i class="fas fa-cog"></i>系统设置
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
        <div class="admin-sidebar-footer">
            <button id="theme-toggle" class="btn btn-outline-secondary w-100 mb-2">
                <i class="fas fa-moon"></i>
                <span>切换主题</span>
            </button>
            <button id="logout-btn" class="btn btn-danger w-100">
                <i class="fas fa-sign-out-alt"></i>
                <span>退出登录</span>
            </button>
        </div>
    </aside>

    <!-- 主内容区域 -->
    <main class="admin-content">
        <header class="admin-header">
            <h2 class="admin-title">仪表盘</h2>
            <div class="admin-toolbar">
                <span class="admin-welcome">欢迎回来，{{ current_user.username }}</span>
            </div>
        </header>

        <!-- 系统概览卡片 -->
        <div class="admin-card mb-4">
            <div class="admin-card-header">
                <h3 class="admin-card-title">系统概览</h3>
            </div>
            <div class="admin-card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="admin-stat-card">
                            <i class="fas fa-users"></i>
                            <div class="admin-stat-content">
                                <h4>总用户数</h4>
                                <p>{{ user_count|default(0) }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="admin-stat-card">
                            <i class="fas fa-file-alt"></i>
                            <div class="admin-stat-content">
                                <h4>总文章数</h4>
                                <p>{{ article_count|default(0) }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="admin-stat-card">
                            <i class="fas fa-clock"></i>
                            <div class="admin-stat-content">
                                <h4>运行时间</h4>
                                <p>{{ uptime|default('0天') }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 用户管理卡片 -->
        <div class="admin-card">
            <div class="admin-card-header">
                <h3 class="admin-card-title">用户管理</h3>
                <div class="admin-card-tools">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                        <i class="fas fa-plus"></i> 添加用户
                    </button>
                </div>
            </div>
            <div class="admin-card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>用户名</th>
                                <th>邮箱</th>
                                <th>角色</th>
                                <th>状态</th>
                                <th>注册时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>{{ user.id }}</td>
                                <td>{{ user.username }}</td>
                                <td>{{ user.email }}</td>
                                <td>
                                    <span
                                        class="badge {% if user.role == 'admin' %}bg-danger{% else %}bg-primary{% endif %}">
                                        {{ user.role }}
                                    </span>
                                </td>
                                <td>
                                    <span
                                        class="badge {% if user.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                        {{ '启用' if user.is_active else '禁用' }}
                                    </span>
                                </td>
                                <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editUser({{ user.id }})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser({{ user.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- 添加用户模态框 -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加用户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label class="form-label">用户名</label>
                        <input type="text" class="form-control" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">邮箱</label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">密码</label>
                        <input type="password" class="form-control" name="password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">角色</label>
                        <select class="form-select" name="role" required>
                            <option value="user">普通用户</option>
                            <option value="admin">管理员</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="addUser()">添加</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/admin/common.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin/dashboard.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 主题切换
        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.addEventListener('click', function () {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // 更新图标
            const icon = this.querySelector('i');
            if (newTheme === 'dark') {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        });

        // 退出登录
        const logoutBtn = document.getElementById('logout-btn');
        logoutBtn.addEventListener('click', async function () {
            try {
                const response = await fetch('/admin/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    window.location.href = '/admin/login';
                } else {
                    throw new Error('退出登录失败');
                }
            } catch (error) {
                console.error('退出登录错误:', error);
                alert('退出登录失败，请重试');
            }
        });

        // 设置初始主题
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        if (savedTheme === 'dark') {
            const icon = themeToggle.querySelector('i');
            icon.classList.remove('fa-moon');
            icon.classList.add('fa-sun');
        }
    });

    // 用户管理相关函数
    async function addUser() {
        const form = document.getElementById('addUserForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/admin/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                location.reload();
            } else {
                const error = await response.json();
                alert(error.message || '添加用户失败');
            }
        } catch (error) {
            console.error('添加用户错误:', error);
            alert('添加用户失败，请重试');
        }
    }

    async function editUser(userId) {
        // TODO: 实现编辑用户功能
        alert('编辑用户功能开发中...');
    }

    async function deleteUser(userId) {
        if (!confirm('确定要删除这个用户吗？此操作不可恢复。')) {
            return;
        }

        try {
            const response = await fetch(`/admin/users/${userId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                location.reload();
            } else {
                const error = await response.json();
                alert(error.message || '删除用户失败');
            }
        } catch (error) {
            console.error('删除用户错误:', error);
            alert('删除用户失败，请重试');
        }
    }
</script>
{% endblock %}